<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>schemaJSON数据渲染</title>
  <link rel="stylesheet" href="./css/layui.css">
  <style>
    #form-container {
      width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .form-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .layui-form-item {
      margin-bottom: 15px;
    }

    .field-description {
      color: #666;
      font-size: 12px;
      margin-top: 5px;
    }

    /* 修改标签宽度 */
    .layui-form-label {
      width: 400px;
      box-sizing: border-box;
    }

    /* 调整输入框左侧边距，避免重叠 */
    .layui-input-block {
      margin-left: 430px;
    }
  </style>
</head>

<body>
  <h1 style="text-align: center; margin: 20px 0;">测试json schema数据解析</h1>
  <div>
    <!-- 表单渲染 -->
    <div id="form-container">
      <form class="layui-form">
        <!-- 表单内容将通过JS动态渲染 -->
        <div class="layui-form-item">
          <button type="button" class="layui-btn" id="submitBtn">提交表单</button>
        </div>
      </form>
    </div>
  </div>
  <script src="./js/layui.all.js"></script>
  <script src="./js/amazon.js"></script>
  <script>
    // 获取JSON Schema数据
    async function getSchemaContent () {
      try {
        const response = await fetch('./demo.json');
        return await response.json();
      } catch (error) {
        console.error('获取Schema数据失败:', error);
        return null;
      }
    }

    // 渲染表单字段
    function renderFormFields (formConfig) {
      const formContainer = document.querySelector('#form-container .layui-form');
      let formHtml = '';

      // 遍历所有字段并生成表单
      formConfig.fields.forEach(field => {
        formHtml += renderField(field);
      });

      // 添加提交按钮前的表单内容
      formContainer.innerHTML = formHtml + formContainer.innerHTML;

      // 重新渲染表单
      layui.form.render();

      // 监听表单提交
      document.getElementById('submitBtn').addEventListener('click', function () {
        submitForm();
      });
    }

    // 渲染单个字段
    function renderField (field) {
      let html = `
        <div class="layui-form-item">
          <label class="layui-form-label">${field.label}${field.required ? '<span style="color:red">*</span>' : ''}</label>
          <div class="layui-input-block">
      `;

      // 根据字段类型渲染不同的表单元素
      if (field.type === 'select') {
        html += `<select name="${field.key}" ${field.required ? 'lay-verify="required"' : ''}>
          <option value="">请选择${field.label}</option>`;

        field.options.forEach(option => {
          html += `<option value="${option.value}">${option.label}</option>`;
        });

        html += `</select>`;
      } else {
        html += `<input type="text" name="${field.key}" placeholder="请输入${field.label}" 
          class="layui-input" ${field.required ? 'lay-verify="required"' : ''}>`;
      }

      // 添加字段描述
      if (field.description) {
        html += `<div class="field-description">${field.description}</div>`;
      }

      html += `</div></div>`;

      // 处理数组类型字段（如果有子字段）
      if (field.isArray && field.children && field.children.length > 0) {
        html += `<div class="layui-form-item" style="margin-left: 30px;">`;
        field.children.forEach(child => {
          html += renderField(child);
        });
        html += `</div>`;
      }

      return html;
    }

    // 提交表单
    function submitForm () {
      const form = document.querySelector('.layui-form');
      const formData = {};

      // 收集表单数据
      const formElements = form.querySelectorAll('input, select, textarea');
      formElements.forEach(element => {
        if (element.name && element.value) {
          formData[element.name] = element.value;
        }
      });

      // 使用amazon.js处理表单数据
      const processedData = processFormData(formData);

      // 显示处理后的数据
      layui.layer.open({
        type: 1,
        title: '处理后的表单数据',
        area: ['800px', '600px'],
        content: `<pre style="padding: 20px;">${JSON.stringify(processedData, null, 2)}</pre>`
      });
    }

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', async function () {
      // 获取Schema数据
      const schemaData = await getSchemaContent();
      if (!schemaData) return;

      // 使用amazon.js转换Schema为表单配置
      const formConfig = transformJsonSchemaToForm(schemaData);
      console.log(formConfig);

      // 渲染表单
      renderFormFields(formConfig);
    });
  </script>
</body>

</html>