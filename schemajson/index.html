<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>schemaJSON数据渲染</title>
  <link rel="stylesheet" href="./css/layui.css">
  <style>
    #form-container {
      width: 800px;
      margin: 0 auto;
      padding: 20px;
    }

    .form-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .layui-form-item {
      margin-bottom: 15px;
    }

    .field-description {
      color: #666;
      font-size: 12px;
      margin-top: 5px;
    }

    /* 修改标签宽度 */
    .layui-form-label {
      width: 400px;
      box-sizing: border-box;
    }

    /* 调整输入框左侧边距，避免重叠 */
    .layui-input-block {
      margin-left: 430px;
    }

    /* 分组标题样式 */
    .group-title {
      font-weight: bold;
      margin: 15px 0 10px 0;
      padding: 8px;
      background-color: #f8f8f8;
      border-left: 4px solid #1E9FFF;
    }

    /* 分组内容样式 */
    .group-content {
      margin-left: 20px;
      padding: 10px;
      border-left: 1px dashed #e6e6e6;
    }

    /* 选填属性默认隐藏 */
    .optional-field {
      display: none;
    }

    /* 选填分组默认隐藏 */
    .optional-group {
      display: none;
    }

    /* 更多选填属性按钮 */
    .more-options-btn {
      margin: 20px 0;
      text-align: center;
    }

    .more-options-btn .layui-btn {
      padding: 0 30px;
    }
  </style>
</head>

<body>
  <h1 style="text-align: center; margin: 20px 0;">测试json schema数据解析</h1>
  <div>
    <!-- 表单渲染 -->
    <div id="form-container">
      <form class="layui-form">
        <!-- 表单内容将通过JS动态渲染 -->
        <div class="layui-form-item">
          <button type="button" class="layui-btn" id="submitBtn">提交表单</button>
        </div>
      </form>
    </div>
  </div>
  <script src="./js/layui.all.js"></script>
  <script src="./js/amazon.js"></script>
  <script>
    // 获取JSON Schema数据
    async function getSchemaContent () {
      try {
        const response = await fetch('./demo.json');
        return await response.json();
      } catch (error) {
        console.error('获取Schema数据失败:', error);
        return null;
      }
    }

    // 渲染表单字段
    function renderFormFields (formConfig) {
      const formContainer = document.querySelector('#form-container .layui-form');
      let requiredFieldsHtml = '';
      let optionalFieldsHtml = '';

      // 遍历所有字段并分别生成必填和选填表单
      formConfig.fields.forEach(field => {
        const fieldHtml = renderField(field, field.required);
        if (field.required) {
          requiredFieldsHtml += fieldHtml;
        } else {
          optionalFieldsHtml += fieldHtml;
        }
      });

      // 添加"更多选填属性"按钮
      const moreOptionsBtn = `
        <div class="more-options-btn">
          <button type="button" class="layui-btn layui-btn-normal" id="moreOptionsBtn">
            <span>显示更多选填属性</span> <i class="layui-icon layui-icon-down"></i>
          </button>
        </div>
      `;

      // 组合所有内容
      const formHtml = requiredFieldsHtml + moreOptionsBtn + optionalFieldsHtml;

      // 添加到表单容器
      formContainer.innerHTML = formHtml + formContainer.innerHTML;

      // 重新渲染表单
      layui.form.render();

      // 监听"更多选填属性"按钮点击
      document.getElementById('moreOptionsBtn').addEventListener('click', function () {
        toggleOptionalFields(this);
      });

      // 监听表单提交
      document.getElementById('submitBtn').addEventListener('click', function () {
        submitForm();
      });
    }

    // 切换选填属性的显示/隐藏
    function toggleOptionalFields (btn) {
      const optionalFields = document.querySelectorAll('.optional-field');
      const optionalGroups = document.querySelectorAll('.optional-group');
      const btnText = btn.querySelector('span');
      const btnIcon = btn.querySelector('i');

      // 检查当前是否显示选填字段
      const isShowing = optionalFields.length > 0 && optionalFields[0].style.display === 'block';

      // 切换显示状态
      optionalFields.forEach(field => {
        field.style.display = isShowing ? 'none' : 'block';
      });

      optionalGroups.forEach(group => {
        group.style.display = isShowing ? 'none' : 'block';
      });

      // 更新按钮文本和图标
      if (isShowing) {
        btnText.textContent = '显示更多选填属性';
        btnIcon.className = 'layui-icon layui-icon-down';
      } else {
        btnText.textContent = '隐藏选填属性';
        btnIcon.className = 'layui-icon layui-icon-up';
      }
    }

    // 渲染单个字段
    function renderField (field, isParentRequired = false) {
      // 计算当前字段是否必填（自身必填或父级必填）
      const isRequired = field.required || isParentRequired;

      // 判断是否有子属性
      if (field.isArray && field.children && field.children.length > 0) {
        // 如果只有一个子属性，直接渲染子属性
        if (field.children.length === 1) {
          const child = field.children[0];
          // 使用子属性的label，如果没有则使用父属性的label
          return renderBasicField({
            key: child.key,
            label: child.label || field.label,
            description: child.description || field.description,
            required: isRequired || child.required,
            type: child.type,
            options: child.options
          }, isRequired);
        }
        // 如果有多个子属性，以分组形式渲染
        else {
          // 确定分组是否为选填
          const groupClass = isRequired ? '' : 'optional-group';

          let html = `
            <div class="group-title ${groupClass}">${field.label}${isRequired ? '<span style="color:red">*</span>' : ''}</div>
            <div class="group-content ${groupClass}">
          `;

          // 添加字段描述
          if (field.description) {
            html += `<div class="field-description">${field.description}</div>`;
          }

          // 渲染所有子属性
          field.children.forEach(child => {
            // 如果子属性没有label，则使用父属性的label
            const childWithLabel = {
              ...child,
              label: child.label || field.label,
              description: child.description || '',
              required: isRequired || child.required
            };
            html += renderBasicField(childWithLabel, isRequired);
          });

          html += `</div>`;
          return html;
        }
      }
      // 没有子属性，直接渲染基本字段
      else {
        return renderBasicField(field, isRequired);
      }
    }

    // 渲染基本表单字段（无子属性）
    function renderBasicField (field, isParentRequired = false) {
      // 计算当前字段是否必填（自身必填或父级必填）
      const isRequired = field.required || isParentRequired;

      // 为选填字段添加特殊类名
      const fieldClass = isRequired ? 'layui-form-item' : 'layui-form-item optional-field';

      let html = `
        <div class="${fieldClass}">
          <label class="layui-form-label">${field.label}${isRequired ? '<span style="color:red">*</span>' : ''}</label>
          <div class="layui-input-block">
      `;

      // 根据字段类型渲染不同的表单元素
      if (field.type === 'select') {
        html += `<select name="${field.key}" ${isRequired ? 'lay-verify="required"' : ''}>
          <option value="">请选择${field.label}</option>`;

        field.options.forEach(option => {
          html += `<option value="${option.value}">${option.label}</option>`;
        });

        html += `</select>`;
      } else {
        html += `<input type="text" name="${field.key}" placeholder="请输入${field.label}" 
          class="layui-input" ${isRequired ? 'lay-verify="required"' : ''}>`;
      }

      // 添加字段描述
      if (field.description) {
        html += `<div class="field-description">${field.description}</div>`;
      }

      html += `</div></div>`;

      return html;
    }

    // 提交表单
    function submitForm () {
      const form = document.querySelector('.layui-form');
      const formData = {};

      // 收集表单数据
      const formElements = form.querySelectorAll('input, select, textarea');
      formElements.forEach(element => {
        if (element.name && element.value) {
          formData[element.name] = element.value;
        }
      });

      // 使用amazon.js处理表单数据
      const processedData = processFormData(formData);

      // 显示处理后的数据
      layui.layer.open({
        type: 1,
        title: '处理后的表单数据',
        area: ['800px', '600px'],
        content: `<pre style="padding: 20px;">${JSON.stringify(processedData, null, 2)}</pre>`
      });
    }

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', async function () {
      // 获取Schema数据
      const schemaData = await getSchemaContent();
      if (!schemaData) return;

      // 使用amazon.js转换Schema为表单配置
      const formConfig = transformJsonSchemaToForm(schemaData);
      console.log(formConfig);

      // 渲染表单
      renderFormFields(formConfig);
    });
  </script>
</body>

</html>