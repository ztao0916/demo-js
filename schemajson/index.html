<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>schemaJSON数据渲染</title>
  <link rel="stylesheet" href="./css/layui.css">
  <style>
    #form-container {
      width: 500px;
      margin: 0 auto;
    }
  </style>
</head>

<body>
  <h1>测试json schema数据解析</h1>
  <div>
    <!-- 表单渲染 -->
    <div id="form-container">
      <form class="layui-form">
        <div class="layui-form-item">
          <label class="layui-form-label">用户名</label>
          <div class="layui-input-block">
            <input type="text" name="username" required lay-verify="required" autocomplete="off" placeholder="请输入用户名"
              class="layui-input">
          </div>
        </div>
      </form>
    </div>
  </div>
  <script src="./js/layui.all.js"></script>
  <script>
    async function getSchemaContent () {
      try {
        const response = await fetch('./schema.json');
        const data = await response.json();
        const contentStr = data.data.content;
        const contentJson = JSON.parse(contentStr);     
        return contentJson;
      } catch (error) {
        console.error('获取或解析schema数据时出错:', error);
      }
    }

    // 页面加载完成后执行
    // 渲染表单字段
    function renderFormField(properties, required = [], parentKey = '') {
      let html = '';
      for (const key in properties) {
        const field = properties[key];
        const fullKey = parentKey ? `${parentKey}.${key}` : key;
        const isRequired = required.includes(key);

        html += `
          <div class="layui-form-item">
            <label class="layui-form-label">${isRequired ? '<span style="color: red;">*</span>' : ''}${field.title || key}</label>
            <div class="layui-input-block">
        `;

        // 根据字段类型渲染不同的表单元素
        switch (field.type) {
          case 'string':
            if (field.enum) {
              // 下拉选择框
              html += `<select name="${fullKey}" ${isRequired ? 'lay-verify="required"' : ''} lay-filter="${fullKey}">`;
              html += '<option value="">请选择</option>';
              field.enum.forEach(option => {
                html += `<option value="${option}">${option}</option>`;
              });
              html += '</select>';
            } else {
              // 文本输入框
              html += `<input type="text" name="${fullKey}" ${isRequired ? 'lay-verify="required"' : ''} placeholder="请输入${field.title || key}" class="layui-input">`;
            }
            break;
          case 'number':
          case 'integer':
            html += `<input type="number" name="${fullKey}" ${isRequired ? 'lay-verify="required|number"' : 'lay-verify="number"'} placeholder="请输入${field.title || key}" class="layui-input">`;
            break;
          case 'boolean':
            html += `
              <input type="checkbox" name="${fullKey}" lay-skin="switch" lay-text="是|否">
            `;
            break;
          case 'object':
            if (field.properties) {
              html += renderFormField(field.properties, field.required || [], fullKey);
            }
            break;
        }

        html += `
            </div>
          </div>
        `;
      }
      return html;
    }

    // 处理字段关联关系
    function handleFieldRelations(allOf) {
      if (!allOf || !Array.isArray(allOf)) return;
      
      allOf.forEach(rule => {
        if (rule.if && rule.then) {
          const conditions = rule.if.properties;
          const effects = rule.then.properties;
          
          // 监听条件字段的变化
          for (const field in conditions) {
            layui.form.on(`select(${field})`, function(data) {
              const value = data.value;
              const expectedValue = conditions[field].enum[0];
              
              // 如果满足条件，应用效果
              if (value === expectedValue) {
                for (const effectField in effects) {
                  const element = document.querySelector(`[name="${effectField}"]`);
                  if (element) {
                    // 根据效果类型处理
                    if (effects[effectField].required === true) {
                      element.setAttribute('lay-verify', 'required');
                      element.closest('.layui-form-item')
                        .querySelector('.layui-form-label')
                        .innerHTML = '<span style="color: red;">*</span>' + element.closest('.layui-form-item').querySelector('.layui-form-label').textContent;
                    }
                  }
                }
              }
            });
          }
        }
      });
    }

    window.onload = function () {
      getSchemaContent().then(res => {
        if (!res) return;
        console.log(res);
        
        // 获取表单容器
        const formContainer = document.querySelector('#form-container .layui-form');
        
        // 渲染表单字段
        const formHtml = renderFormField(res.properties, res.required || []);
        formContainer.innerHTML = formHtml;
        
        // 重新渲染表单
        layui.form.render();
        
        // 处理字段关联关系
        handleFieldRelations(res.allOf);
      });
    };
  </script>
</body>

</html>