<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>亚马逊产品信息表单</title>
  <link rel="stylesheet" href="./css/layui.css">
  <style>
    .container {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .header {
      margin-bottom: 20px;
      border-bottom: 1px solid #eee;
      padding-bottom: 10px;
    }
    .header h1 {
      font-size: 24px;
      color: #333;
    }
    .form-section {
      margin-bottom: 30px;
      background: #fff;
      padding: 20px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .form-section-title {
      font-size: 18px;
      margin-bottom: 15px;
      color: #333;
      border-bottom: 2px solid #1E9FFF;
      padding-bottom: 8px;
    }
    .layui-form-item {
      margin-bottom: 25px;
    }
    .field-help {
      color: #666;
      font-size: 13px;
      margin-top: 5px;
    }
    .required-field .layui-form-label:after {
      content: '*';
      color: red;
      margin-left: 4px;
    }
    .field-examples {
      color: #999;
      font-size: 12px;
      margin-top: 5px;
    }
    .field-enum {
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>亚马逊产品信息表单</h1>
    </div>
    <div class="layui-form" id="productForm">
      <!-- 表单内容将由JavaScript动态生成 -->
    </div>
  </div>

  <!-- 引入必要的脚本 -->
  <script src="./js/layui.all.js"></script>
  <script src="./js/propertiesHandler.js"></script>
  <script>
    // 初始化layui
    const layui = window.layui;
    const form = layui.form;
    const $ = layui.$;

    // 字段分组配置
    const FIELD_GROUPS = {
      basic: {
        title: '基本信息',
        fields: ['item_name', 'brand', 'item_type_keyword']
      },
      identifiers: {
        title: '标识信息',
        fields: ['externally_assigned_product_identifier', 'merchant_suggested_asin']
      },
      product: {
        title: '产品信息',
        fields: ['model_number', 'model_name', 'manufacturer']
      },
      attributes: {
        title: '属性信息',
        fields: ['color', 'size', 'material', 'style']
      },
      packaging: {
        title: '包装信息',
        fields: ['package_level', 'package_contains_sku']
      },
      other: {
        title: '其他信息',
        fields: []  // 将未分类的字段放在这里
      }
    };

    // 加载并处理schema
    fetch('./demo.json')
      .then(response => response.json())
      .then(schema => {
        // 创建处理器实例
        const handler = new PropertiesHandler(schema);
        const processedProps = handler.process();
        
        // 渲染表单
        renderForm(processedProps, schema.required || []);
        
        // 重新渲染layui表单
        form.render();
      })
      .catch(error => {
        console.error('加载schema失败:', error);
      });

    // 渲染表单的函数
    function renderForm(processedProps, requiredFields) {
      const formContainer = document.getElementById('productForm');
      
      // 创建字段分组映射
      const fieldGroups = {};
      Object.keys(processedProps).forEach(key => {
        // 获取基础字段名（去掉.0.value等后缀）
        const baseField = key.split('.')[0];
        let grouped = false;
        
        // 将字段分配到对应的组
        for (const [groupKey, group] of Object.entries(FIELD_GROUPS)) {
          if (group.fields.includes(baseField)) {
            if (!fieldGroups[groupKey]) {
              fieldGroups[groupKey] = [];
            }
            if (!fieldGroups[groupKey].includes(key)) {
              fieldGroups[groupKey].push(key);
            }
            grouped = true;
            break;
          }
        }
        
        // 未分组的字段放入其他组
        if (!grouped) {
          if (!fieldGroups.other) {
            fieldGroups.other = [];
          }
          if (!fieldGroups.other.includes(key)) {
            fieldGroups.other.push(key);
          }
        }
      });

      // 渲染每个分组
      Object.entries(FIELD_GROUPS).forEach(([groupKey, group]) => {
        if (fieldGroups[groupKey] && fieldGroups[groupKey].length > 0) {
          const section = createFormSection(group.title);
          
          // 渲染分组中的字段
          fieldGroups[groupKey].forEach(fieldKey => {
            if (processedProps[fieldKey]) {
              const baseField = fieldKey.split('.')[0];
              const field = createFormField(
                processedProps[fieldKey],
                fieldKey,
                requiredFields.includes(baseField)
              );
              section.appendChild(field);
            }
          });
          
          formContainer.appendChild(section);
        }
      });

      // 添加提交按钮
      const submitBtn = document.createElement('div');
      submitBtn.className = 'layui-form-item';
      submitBtn.innerHTML = `
        <div class="layui-input-block">
          <button class="layui-btn" lay-submit lay-filter="productForm">提交</button>
          <button type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
      `;
      formContainer.appendChild(submitBtn);
    }

    // 创建表单区域
    function createFormSection(title) {
      const section = document.createElement('div');
      section.className = 'form-section';
      section.innerHTML = `<div class="form-section-title">${title}</div>`;
      return section;
    }

    // 创建表单字段
    function createFormField(fieldConfig, name, required) {
      const field = document.createElement('div');
      field.className = `layui-form-item ${required ? 'required-field' : ''}`;
      
      let input;
      if (!fieldConfig.editable) {
        // 不可编辑字段
        input = `
          <div class="layui-input-block">
            <input type="text" 
                   class="layui-input layui-disabled" 
                   disabled 
                   placeholder="该字段不可编辑"
            >
          </div>
        `;
      } else if (fieldConfig.enum) {
        // 枚举类型字段
        input = `
          <div class="layui-input-block">
            <select name="${name}" class="field-enum" ${required ? 'lay-verify="required"' : ''}>
              <option value="">请选择${fieldConfig.tTitle}</option>
              ${fieldConfig.enum.map((value, index) => `
                <option value="${value}">${fieldConfig.enumNames?.[index] || value}</option>
              `).join('')}
            </select>
          </div>
        `;
      } else {
        // 普通输入字段
        input = `
          <div class="layui-input-block">
            <input type="text" 
                   name="${name}" 
                   class="layui-input"
                   ${required ? 'lay-verify="required"' : ''}
                   ${fieldConfig.maxLength ? `maxlength="${fieldConfig.maxLength}"` : ''}
                   placeholder="请输入${fieldConfig.tTitle}"
            >
          </div>
        `;
      }

      field.innerHTML = `
        <label class="layui-form-label">${fieldConfig.tTitle}</label>
        ${input}
        <div class="layui-input-block">
          <div class="field-help">${fieldConfig.tDescription}</div>
          ${fieldConfig.examples?.length ? `
            <div class="field-examples">示例: ${fieldConfig.examples.join(', ')}</div>
          ` : ''}
        </div>
      `;
      
      return field;
    }

    // 监听表单提交
    form.on('submit(productForm)', function(data) {
      console.log('表单数据:', data.field);
      layer.msg('提交成功');
      return false;
    });
  </script>
</body>
</html>